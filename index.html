<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMystery Daily</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .guess-list::-webkit-scrollbar { width: 8px; }
        .guess-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .guess-list::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Toast Animations */
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideDown 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800 relative">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-0 right-0 z-[60] flex flex-col items-center gap-2 pointer-events-none"></div>

    <div id="app" class="max-w-2xl mx-auto p-4 flex flex-col h-screen">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-indigo-600 mb-2"><i class="fas fa-puzzle-piece"></i> WikiMystery</h1>
            <p class="text-gray-600">Find the secret Wikipedia article!</p>
        </header>

        <!-- Loading State -->
        <div id="loading-screen" class="hidden fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
                <p class="mt-2 font-medium">Consulting the Archives...</p>
                <p class="text-xs text-gray-500 mt-1" id="loading-text">Finding a globally recognized topic...</p>
            </div>
        </div>

        <!-- Game Won State -->
        <div id="win-screen" class="hidden bg-green-100 border-2 border-green-500 rounded-xl p-6 mb-6 text-center animate-pop">
            <h2 class="text-2xl font-bold text-green-700 mb-2">ðŸŽ‰ You Found It!</h2>
            <p class="text-lg">The article was <strong id="reveal-title"></strong></p>
            <p class="text-sm text-green-600 mt-2" id="win-stats"></p>
            <button onclick="initGame()" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                Play Again
            </button>
        </div>

        <!-- Hints Section -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-200 shrink-0">
            <h3 class="font-bold text-gray-700 mb-3"><i class="far fa-lightbulb text-yellow-500"></i> Archive Notes</h3>
            
            <!-- Default Summary (Always Visible) -->
            <div id="summary-display" class="mb-4 text-sm text-gray-700 bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400 italic leading-relaxed max-h-40 overflow-y-auto">
                Loading redacted summary...
            </div>

            <div class="flex justify-between items-center mb-2 border-t pt-3 border-gray-100">
                <span class="text-xs text-gray-400" id="hint-status">0/2 Extra Hints Used</span>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button id="btn-hint-1" onclick="revealHint(1)" class="text-sm bg-indigo-50 text-indigo-700 py-2 px-3 rounded border border-indigo-200 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-tags"></i> Unlock Categories
                </button>
                <button id="btn-hint-2" onclick="revealHint(2)" class="text-sm bg-indigo-50 text-indigo-700 py-2 px-3 rounded border border-indigo-200 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-image"></i> Unlock Image
                </button>
            </div>

            <div class="mt-3 text-center">
                <button id="give-up-btn" onclick="giveUp()" class="text-xs text-red-400 hover:text-red-600 underline decoration-dotted transition-colors">I give up, show me the answer</button>
            </div>

            <!-- Hint Outputs -->
            <div id="hint-display-1" class="hidden mt-3 text-sm text-gray-600 bg-gray-50 p-3 rounded border-l-4 border-indigo-400"></div>
            
            <div id="hint-display-2" class="hidden mt-3 flex justify-center p-3 bg-gray-50 rounded border border-gray-200">
                <div class="relative">
                    <!-- Reduced height to prevent covering history -->
                    <img id="hint-image" src="" class="max-h-32 rounded shadow-sm object-contain" alt="Article Hint">
                    <p class="text-xs text-center text-gray-400 mt-1 italic">Image from article</p>
                </div>
            </div>
        </div>

        <!-- Search Input -->
        <div class="relative mb-6 z-20 shrink-0">
            <div class="relative">
                <input type="text" id="search-input" 
                    class="w-full p-4 pl-12 rounded-xl shadow-lg border-2 border-transparent focus:border-indigo-500 focus:outline-none text-lg transition" 
                    placeholder="Search Wikipedia..." 
                    autocomplete="off">
                <i class="fas fa-search absolute left-4 top-5 text-gray-400"></i>
            </div>
            
            <!-- Autocomplete Dropdown -->
            <div id="autocomplete-list" class="absolute w-full bg-white mt-1 rounded-xl shadow-xl border border-gray-100 overflow-hidden hidden max-h-60 overflow-y-auto">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- Guesses List -->
        <div class="flex-1 overflow-hidden flex flex-col bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-3 border-b border-gray-100 bg-gray-50 font-medium text-gray-500 text-sm flex justify-between">
                <span>Guess History</span>
                <span id="guess-count">0 guesses</span>
            </div>
            <div id="guesses-container" class="flex-1 overflow-y-auto p-4 space-y-3 guess-list">
                <!-- Guesses injected here -->
                <div id="empty-state" class="text-center text-gray-400 py-10">
                    <i class="fas fa-arrow-up mb-2"></i>
                    <p>Make your first guess!</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Game State ---
        const API_BASE = "https://en.wikipedia.org/w/api.php";
        let targetArticle = null;
        let targetLinks = new Set();
        let targetCategories = [];
        let targetSummary = "";
        let targetImage = null;
        let guesses = [];
        let hintsUnlocked = 0;
        let isGameOver = false;
        let giveUpClickCount = 0;

        // --- Initialization ---
        window.onload = initGame;

        async function initGame() {
            // Reset State
            guesses = [];
            hintsUnlocked = 0;
            isGameOver = false;
            giveUpClickCount = 0;
            
            // UI Resets
            document.getElementById('search-input').value = '';
            document.getElementById('guesses-container').innerHTML = '<div id="empty-state" class="text-center text-gray-400 py-10"><i class="fas fa-arrow-up mb-2"></i><p>Make your first guess!</p></div>';
            
            // Reset Win/Loss Screen styles
            const winScreen = document.getElementById('win-screen');
            winScreen.classList.add('hidden');
            winScreen.classList.remove('bg-red-50', 'border-red-200');
            winScreen.classList.add('bg-green-100', 'border-green-500');
            
            const winTitle = winScreen.querySelector('h2');
            winTitle.innerText = "ðŸŽ‰ You Found It!";
            winTitle.classList.remove('text-red-700');
            winTitle.classList.add('text-green-700');

            document.getElementById('search-input').disabled = false;
            document.getElementById('btn-hint-1').disabled = false;
            document.getElementById('btn-hint-1').classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
            document.getElementById('btn-hint-1').classList.add('bg-indigo-50', 'text-indigo-700');
            
            document.getElementById('btn-hint-2').disabled = false;
            document.getElementById('btn-hint-2').innerHTML = '<i class="fas fa-image"></i> Unlock Image';
            document.getElementById('btn-hint-2').classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
            document.getElementById('btn-hint-2').classList.add('bg-indigo-50', 'text-indigo-700');
            
            // Reset Give Up Button
            const giveUpBtn = document.getElementById('give-up-btn');
            giveUpBtn.innerText = "I give up, show me the answer";
            giveUpBtn.classList.remove('text-red-600', 'font-bold');
            giveUpBtn.classList.add('text-red-400');

            document.getElementById('hint-display-1').classList.add('hidden');
            document.getElementById('hint-display-2').classList.add('hidden');
            document.getElementById('hint-status').innerText = "0/2 Extra Hints Used";
            document.getElementById('guess-count').innerText = "0 guesses";
            document.getElementById('summary-display').innerText = "Loading redacted summary...";

            toggleLoading(true);

            // 1. Pick Random Article via API
            try {
                const randomTitle = await getRandomArticle();
                
                // 2. Fetch Target Data
                const data = await fetchWikiData(randomTitle);
                if (!data) throw new Error("Failed to load target");

                targetArticle = data.title;
                targetLinks = new Set(data.links || []);
                targetCategories = data.categories || [];
                targetSummary = data.extract || "No summary available.";
                targetImage = data.image;

                console.log("Target (Shh!):", targetArticle);

                // Show default redacted summary immediately
                renderRedactedSummary();

                // Check if image exists for hint 2
                if (!targetImage) {
                    const btn2 = document.getElementById('btn-hint-2');
                    btn2.disabled = true;
                    btn2.innerHTML = '<i class="fas fa-image-slash"></i> No Image';
                    btn2.classList.add('opacity-50', 'cursor-not-allowed');
                }

            } catch (e) {
                showToast("Error starting game. Please reload.", "error");
                console.error(e);
            } finally {
                toggleLoading(false);
            }
        }

        // --- Core Logic ---

        async function getRandomArticle() {
            // "Deep Search" Strategy
            // We fetch 50 random pages (max reasonable batch) to widen the net.
            // We then strictly filter for articles that exist in multiple languages (langlinks).
            // This is the strongest proxy for "Global Notability" available in the public API.
            
            const params = new URLSearchParams({
                action: "query",
                format: "json",
                generator: "random",
                grnnamespace: "0",     // Main namespace only
                grnlimit: "50",        // Fetch 50 candidates to find the best one
                prop: "info|pageimages|pageprops|langlinks",
                inprop: "url",
                piprop: "thumbnail",
                pithumbsize: "100",
                lllimit: "max",        // Get max language links to count accurately
                origin: "*"
            });

            try {
                const res = await fetch(`${API_BASE}?${params.toString()}`);
                const data = await res.json();
                
                if (!data.query || !data.query.pages) {
                    throw new Error("No pages returned");
                }

                const pages = Object.values(data.query.pages);

                // Filter & Score Candidates
                const scoredCandidates = pages.map(p => {
                    const isDisambiguation = p.pageprops && p.pageprops.disambiguation !== undefined;
                    const isList = p.title.startsWith("List of") || p.title.startsWith("Index of");
                    const hasImage = p.thumbnail !== undefined;
                    const langCount = p.langlinks ? p.langlinks.length : 0;
                    
                    // Heavy weighting for LangCount (Notability)
                    // If an article has < 5 languages, it's likely too obscure.
                    let score = langCount; 
                    
                    if (hasImage) score += 10;
                    
                    // Penalize lists and disambiguations heavily (essentially remove them)
                    if (isDisambiguation || isList) score = -999;

                    return {
                        title: p.title,
                        valid: score > 0, // Must have some positive traits
                        score: score,
                        langCount: langCount
                    };
                });

                // Sort by Score (Descending)
                scoredCandidates.sort((a, b) => b.score - a.score);

                console.log("Top Candidate:", scoredCandidates[0]);

                if (scoredCandidates.length > 0 && scoredCandidates[0].valid) {
                    return scoredCandidates[0].title;
                } else {
                    console.log("No valid candidates found in batch, retrying...");
                    return getRandomArticle(); // Recursion if batch was full of junk
                }

            } catch (e) {
                console.error("Filter failed, retrying...", e);
                return "The Internet"; // Ultimate fallback
            }
        }

        async function handleGuess(title) {
            if (isGameOver) return;
            
            // Validate if already guessed
            if (guesses.some(g => g.title.toLowerCase() === title.toLowerCase())) {
                showToast("You already guessed that!", "error");
                return;
            }

            toggleLoading(true);
            
            try {
                const data = await fetchWikiData(title);
                if (!data) {
                    showToast("Article not found in Wikipedia!", "error");
                    toggleLoading(false);
                    return;
                }

                // Calculate Score
                const result = calculateSimilarity(data.title, data.links);
                
                // Add to history
                const guessObj = {
                    title: data.title,
                    ...result
                };
                guesses.unshift(guessObj);
                
                renderGuess(guessObj);
                updateStats();

                // Check Win
                if (result.type === 'win') {
                    triggerWin();
                }

                // Clear input
                const searchInput = document.getElementById('search-input');
                searchInput.value = '';
                document.getElementById('autocomplete-list').classList.add('hidden');

            } catch (e) {
                console.error(e);
                showToast("Error checking guess", "error");
            } finally {
                toggleLoading(false);
            }
        }

        function calculateSimilarity(guessTitle, guessLinksArr) {
            if (guessTitle.toLowerCase() === targetArticle.toLowerCase()) {
                return { score: 100, message: "Correct!", color: "bg-green-500", type: 'win' };
            }

            const guessLinks = new Set(guessLinksArr);
            const targetLinksToGuess = targetLinks.has(guessTitle);
            const guessLinksToTarget = guessLinks.has(targetArticle);

            if (targetLinksToGuess || guessLinksToTarget) {
                return { score: 85, message: "Direct Link!", color: "bg-orange-500", type: 'close' };
            }

            const intersection = new Set([...targetLinks].filter(x => guessLinks.has(x)));
            const union = new Set([...targetLinks, ...guessLinks]);
            
            let jaccard = 0;
            if (union.size > 0) {
                jaccard = intersection.size / union.size;
            }

            let displayScore = Math.min(Math.round(jaccard * 1000), 70); 
            
            let message = `${intersection.size} shared links`;
            let color = "bg-blue-500";

            if (intersection.size === 0) {
                message = "No connection";
                color = "bg-gray-400";
                displayScore = 5;
            }

            return { score: displayScore, message: message, color: color, type: 'normal' };
        }

        // --- Wikipedia API Helper ---
        
        async function fetchWikiData(title) {
            const params = new URLSearchParams({
                action: "query",
                format: "json",
                prop: "links|categories|extracts|pageimages",
                titles: title,
                pllimit: "max",
                cllimit: "max",
                exintro: "1",
                explaintext: "1",
                pithumbsize: "400", // Image Width
                origin: "*"
            });

            const res = await fetch(`${API_BASE}?${params.toString()}`);
            const data = await res.json();
            
            const pages = data.query.pages;
            const pageId = Object.keys(pages)[0];
            
            if (pageId === "-1") return null;

            const page = pages[pageId];
            return {
                title: page.title,
                links: page.links ? page.links.map(l => l.title) : [],
                categories: page.categories ? page.categories.map(c => c.title.replace("Category:", "")) : [],
                extract: page.extract,
                image: page.thumbnail ? page.thumbnail.source : null
            };
        }

        async function searchAutocomplete(term) {
            if (term.length < 2) return [];
            
            const params = new URLSearchParams({
                action: "opensearch",
                search: term,
                limit: "5",
                namespace: "0",
                format: "json",
                origin: "*"
            });

            const res = await fetch(`${API_BASE}?${params.toString()}`);
            const data = await res.json();
            return data[1]; 
        }

        // --- UI Rendering ---

        function renderGuess(guess) {
            const container = document.getElementById('guesses-container');
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            const div = document.createElement('div');
            div.className = "bg-white p-3 rounded-lg border border-gray-200 shadow-sm animate-pop flex items-center justify-between";
            div.innerHTML = `
                <div class="flex-1">
                    <div class="font-bold text-gray-800">${guess.title}</div>
                    <div class="text-xs text-gray-500">${guess.message}</div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${guess.color}" style="width: ${guess.score}%"></div>
                    </div>
                    <span class="text-sm font-bold w-8 text-right">${guess.score}%</span>
                </div>
            `;
            container.prepend(div);
        }

        function updateStats() {
            document.getElementById('guess-count').innerText = `${guesses.length} guess${guesses.length !== 1 ? 'es' : ''}`;
        }

        function renderRedactedSummary() {
            const display = document.getElementById('summary-display');
            let censored = targetSummary.substring(0, 250) + "...";
            
            const titleWords = targetArticle.split(/[\s-]+/); 
            titleWords.sort((a, b) => b.length - a.length);

            titleWords.forEach(word => {
                if (word.length > 2) {
                    const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`\\b${escapedWord}\\b`, "gi"); 
                    censored = censored.replace(regex, "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ");
                }
            });

            display.innerText = censored;
        }

        function revealHint(level) {
            hintsUnlocked++;
            document.getElementById('hint-status').innerText = `${hintsUnlocked}/2 Extra Hints Used`;

            if (level === 1) {
                // Reveal Categories
                const display = document.getElementById('hint-display-1');
                
                // Aggressive filtering for "boring" categories AND spoilers
                const cleanCats = targetCategories.filter(c => {
                    const lower = c.toLowerCase();
                    const titleLower = targetArticle.toLowerCase();

                    // Filter out category if it contains the article title (Spoiler protection)
                    if (lower.includes(titleLower)) return false;

                    return !lower.includes("articles") && 
                           !lower.includes("pages") && 
                           !lower.includes("webarchive") &&
                           !lower.includes("cs1") &&
                           !lower.includes("wikipedia") &&
                           !lower.includes("use dmy") &&
                           !lower.includes("use mdy") &&
                           !lower.includes("containing") &&
                           !lower.includes("all stub") &&
                           !lower.includes("short description");
                });

                if (cleanCats.length > 0) {
                    display.innerHTML = `<strong>Categories:</strong> ${cleanCats.slice(0, 5).join(", ")}`;
                } else {
                    display.innerText = "No descriptive categories found.";
                }
                
                display.classList.remove('hidden');
                
                const btn = document.getElementById('btn-hint-1');
                btn.disabled = true;
                btn.classList.remove('bg-indigo-50', 'text-indigo-700');
                btn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');

            } else if (level === 2) {
                // Reveal Image
                const display = document.getElementById('hint-display-2');
                const img = document.getElementById('hint-image');
                
                if (targetImage) {
                    img.src = targetImage;
                    display.classList.remove('hidden');
                }
                
                const btn = document.getElementById('btn-hint-2');
                btn.disabled = true;
                btn.classList.remove('bg-indigo-50', 'text-indigo-700');
                btn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
            }
        }

        function triggerWin() {
            isGameOver = true;
            document.getElementById('reveal-title').innerText = targetArticle;
            document.getElementById('win-stats').innerText = `Solved in ${guesses.length} guesses!`;
            document.getElementById('win-screen').classList.remove('hidden');
            document.getElementById('search-input').disabled = true;
            
            if(targetImage) {
                document.getElementById('hint-display-2').classList.remove('hidden');
                document.getElementById('hint-image').src = targetImage;
            }
            document.getElementById('summary-display').innerText = targetSummary.substring(0, 500) + "...";
            document.getElementById('summary-display').classList.remove('italic');
        }

        // New Give Up Logic (No Alert/Confirm)
        function giveUp() {
            const btn = document.getElementById('give-up-btn');
            
            // First Click: Warn
            if (giveUpClickCount === 0) {
                giveUpClickCount++;
                btn.innerText = "Are you sure? Click again to confirm.";
                btn.classList.remove('text-red-400');
                btn.classList.add('text-red-600', 'font-bold');
                return;
            }

            // Second Click: Execute
            triggerWin(); 
            
            // Override styles for "Game Over" look
            const winScreen = document.getElementById('win-screen');
            winScreen.classList.remove('bg-green-100', 'border-green-500');
            winScreen.classList.add('bg-red-50', 'border-red-200');
            
            const winTitle = winScreen.querySelector('h2');
            winTitle.innerText = "ðŸ˜¢ Game Over";
            winTitle.classList.remove('text-green-700');
            winTitle.classList.add('text-red-700');
            
            document.getElementById('win-stats').innerText = "Better luck next time!";
        }

        // --- Custom Toast Notification (Replaces Alert) ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const bgClass = type === 'error' ? 'bg-red-500' : 'bg-indigo-600';
            const icon = type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>';
            
            toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium pointer-events-auto toast-enter`;
            toast.innerHTML = `${icon} <span>${message}</span>`;
            
            container.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transition = 'all 0.3s ease-in';
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleLoading(show) {
            const el = document.getElementById('loading-screen');
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        // --- Event Listeners ---

        const searchInput = document.getElementById('search-input');
        const autoList = document.getElementById('autocomplete-list');

        let timeout = null;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(timeout);
            const term = e.target.value;
            
            if (term.length < 2) {
                autoList.classList.add('hidden');
                return;
            }

            timeout = setTimeout(async () => {
                const results = await searchAutocomplete(term);
                if (results.length > 0) {
                    autoList.innerHTML = results.map(r => 
                        `<div class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100" onclick="selectSuggestion('${r.replace(/'/g, "\\'")}')">${r}</div>`
                    ).join('');
                    autoList.classList.remove('hidden');
                } else {
                    autoList.classList.add('hidden');
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !autoList.contains(e.target)) {
                autoList.classList.add('hidden');
            }
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && searchInput.value) {
                handleGuess(searchInput.value);
                autoList.classList.add('hidden');
            }
        });

        window.selectSuggestion = (title) => {
            searchInput.value = title;
            autoList.classList.add('hidden');
            handleGuess(title);
        };

    </script>
</body>
</html>
