<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiMystery Daily</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Toast Animations */
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideDown 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800 relative pb-10">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-0 right-0 z-[60] flex flex-col items-center gap-2 pointer-events-none"></div>

    <div id="app" class="max-w-2xl mx-auto p-4 flex flex-col">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-indigo-600 mb-2"><i class="fas fa-puzzle-piece"></i> WikiMystery</h1>
            <p class="text-gray-600">Find the secret Wikipedia article!</p>
        </header>

        <!-- Loading State -->
        <div id="loading-screen" class="hidden fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
                <p class="mt-2 font-medium">Consulting the Archives...</p>
                <p class="text-xs text-gray-500 mt-1" id="loading-text">Analyzing global traffic charts...</p>
            </div>
        </div>

        <!-- Game Won State -->
        <div id="win-screen" class="hidden bg-green-100 border-2 border-green-500 rounded-xl p-6 mb-6 text-center animate-pop">
            <h2 class="text-2xl font-bold text-green-700 mb-2">ðŸŽ‰ You Found It!</h2>
            <p class="text-lg">The article was <strong id="reveal-title"></strong></p>
            <p class="text-sm text-green-600 mt-2" id="win-stats"></p>
            
            <a id="wiki-link" href="#" target="_blank" class="inline-block mt-3 text-green-700 underline font-medium hover:text-green-800">
                Read full article on Wikipedia <i class="fas fa-external-link-alt text-xs"></i>
            </a>

            <div class="mt-4">
                <button onclick="initGame()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition shadow-md">
                    Play Again
                </button>
            </div>
        </div>

        <!-- Hints Section -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6 border border-gray-200">
            <h3 class="font-bold text-gray-700 mb-3"><i class="far fa-lightbulb text-yellow-500"></i> Archive Notes</h3>
            
            <!-- Default Hint (Context Clue) -->
            <div class="mb-1">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Initial Clue</span>
            </div>
            <div id="context-display" class="mb-4 text-sm text-gray-700 bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400 italic leading-relaxed">
                Loading clue...
            </div>

            <div class="flex justify-between items-center mb-3 border-t pt-3 border-gray-100">
                <span class="text-xs text-gray-400" id="hint-status">0/4 Extra Hints Used</span>
            </div>
            
            <!-- Hint Buttons Grid -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="btn-hint-0" onclick="revealHint(0)" class="text-sm bg-indigo-50 text-indigo-700 py-3 px-3 rounded border border-indigo-200 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-align-left"></i> Expand Clue
                </button>
                <button id="btn-hint-1" onclick="revealHint(1)" class="text-sm bg-indigo-50 text-indigo-700 py-3 px-3 rounded border border-indigo-200 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-file-alt"></i> Reveal Summary
                </button>
                <button id="btn-hint-2" onclick="revealHint(2)" class="text-sm bg-indigo-50 text-indigo-700 py-3 px-3 rounded border border-indigo-200 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-tags"></i> Reveal Categories
                </button>
                <button id="btn-hint-3" onclick="revealHint(3)" class="text-sm bg-indigo-50 text-indigo-700 py-3 px-3 rounded border border-indigo-200 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-image"></i> Reveal Image
                </button>
            </div>

            <div class="text-center mb-2">
                <button id="give-up-btn" onclick="giveUp()" class="text-xs text-red-400 hover:text-red-600 underline decoration-dotted transition-colors">I give up, show me the answer</button>
            </div>

            <!-- Dynamic Hint Outputs -->
            <div class="space-y-3">
                <!-- Summary Hint Output -->
                <div id="hint-display-1" class="hidden text-sm text-gray-600 bg-gray-50 p-4 rounded border-l-4 border-indigo-400">
                    <span class="block text-xs font-bold text-indigo-400 mb-1">REDACTED SUMMARY</span>
                    <span id="summary-text"></span>
                </div>

                <!-- Categories Hint Output -->
                <div id="hint-display-2" class="hidden text-sm text-gray-600 bg-gray-50 p-4 rounded border-l-4 border-indigo-400"></div>
                
                <!-- Image Hint Output -->
                <div id="hint-display-3" class="hidden flex justify-center p-4 bg-gray-50 rounded border border-gray-200">
                    <div class="relative w-full text-center">
                        <img id="hint-image" src="" class="max-h-80 w-auto mx-auto rounded shadow-sm object-contain" alt="Article Hint">
                        <p class="text-xs text-center text-gray-400 mt-2 italic">Image from article</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Input -->
        <div class="relative mb-6 z-20">
            <div class="relative">
                <input type="text" id="search-input" 
                    class="w-full p-4 pl-12 rounded-xl shadow-lg border-2 border-transparent focus:border-indigo-500 focus:outline-none text-lg transition" 
                    placeholder="Search Wikipedia..." 
                    autocomplete="off">
                <i class="fas fa-search absolute left-4 top-5 text-gray-400"></i>
            </div>
            
            <!-- Autocomplete Dropdown -->
            <div id="autocomplete-list" class="absolute w-full bg-white mt-1 rounded-xl shadow-xl border border-gray-100 overflow-hidden hidden max-h-60 overflow-y-auto">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- Guesses List -->
        <div class="flex-col bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-3 border-b border-gray-100 bg-gray-50 font-medium text-gray-500 text-sm flex justify-between">
                <span>Guess History</span>
                <span id="guess-count">0 guesses</span>
            </div>
            <div id="guesses-container" class="p-4 space-y-3">
                <!-- Guesses injected here -->
                <div id="empty-state" class="text-center text-gray-400 py-10">
                    <i class="fas fa-arrow-up mb-2"></i>
                    <p>Make your first guess!</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Game State ---
        const API_BASE = "https://en.wikipedia.org/w/api.php";
        let targetArticle = null;
        let targetLinks = new Set();
        let targetCategories = [];
        let targetSummary = "";
        let targetContextData = { sentence: "", full: "" }; 
        let targetImage = null;
        let targetUrl = "";
        let guesses = [];
        let hintsUnlocked = 0;
        let isGameOver = false;
        let giveUpClickCount = 0;

        // --- Initialization ---
        window.onload = initGame;

        async function initGame() {
            // Reset State
            guesses = [];
            hintsUnlocked = 0;
            isGameOver = false;
            giveUpClickCount = 0;
            
            // UI Resets
            document.getElementById('search-input').value = '';
            document.getElementById('guesses-container').innerHTML = '<div id="empty-state" class="text-center text-gray-400 py-10"><i class="fas fa-arrow-up mb-2"></i><p>Make your first guess!</p></div>';
            
            // Reset Win/Loss Screen styles
            const winScreen = document.getElementById('win-screen');
            winScreen.classList.add('hidden');
            winScreen.classList.remove('bg-red-50', 'border-red-200');
            winScreen.classList.add('bg-green-100', 'border-green-500');
            
            const winTitle = winScreen.querySelector('h2');
            winTitle.innerText = "ðŸŽ‰ You Found It!";
            winTitle.classList.remove('text-red-700');
            winTitle.classList.add('text-green-700');

            document.getElementById('search-input').disabled = false;
            
            // Reset Hint Buttons
            ['btn-hint-0', 'btn-hint-1', 'btn-hint-2', 'btn-hint-3'].forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
                btn.classList.add('bg-indigo-50', 'text-indigo-700');
            });
            
            // Explicitly Reset Button Text
            document.getElementById('btn-hint-0').innerHTML = '<i class="fas fa-align-left"></i> Expand Clue';
            document.getElementById('btn-hint-3').innerHTML = '<i class="fas fa-image"></i> Reveal Image';

            // Reset Give Up Button
            const giveUpBtn = document.getElementById('give-up-btn');
            giveUpBtn.innerText = "I give up, show me the answer";
            giveUpBtn.classList.remove('text-red-600', 'font-bold');
            giveUpBtn.classList.add('text-red-400');

            document.getElementById('hint-display-1').classList.add('hidden');
            document.getElementById('hint-display-2').classList.add('hidden');
            document.getElementById('hint-display-3').classList.add('hidden');
            document.getElementById('hint-status').innerText = "0/4 Extra Hints Used";
            document.getElementById('guess-count').innerText = "0 guesses";
            document.getElementById('context-display').innerText = "Loading clue...";

            toggleLoading(true);

            // 1. Pick Random Article via API
            try {
                const randomTitle = await getRandomArticle();
                
                // 2. Fetch Target Data
                const data = await fetchWikiData(randomTitle);
                if (!data) throw new Error("Failed to load target");

                targetArticle = data.title;
                targetLinks = new Set(data.links || []);
                targetCategories = data.categories || [];
                targetSummary = data.summary || "No summary available.";
                targetImage = data.image;
                targetUrl = data.url;
                
                // Process Context Clue
                targetContextData = processContextClue(data.fullText, data.title);

                console.log("Target (Shh!):", targetArticle);

                // Show context immediately
                document.getElementById('context-display').innerText = targetContextData.sentence;

                // --- SPOILER PROTECTION: Smart Image Filter ---
                if (targetImage) {
                    // Split title into "Significant Words" (Length > 5)
                    // Increased threshold to 5 to avoid blocking on words like "Flag" or "Rock"
                    const significantWords = targetArticle.toLowerCase().split(/[\s-]+/).filter(w => w.length > 5);
                    const imageSrcLower = targetImage.toLowerCase();
                    
                    const isSpoiler = significantWords.some(word => imageSrcLower.includes(word));
                    
                    if (isSpoiler) {
                        console.log("Spoiler image detected (strict filter), removing:", targetImage);
                        targetImage = null; 
                    }
                }

                // Update Image Button State based on availability/spoiler status
                const btn3 = document.getElementById('btn-hint-3');
                if (!targetImage) {
                    btn3.disabled = true;
                    btn3.innerHTML = '<i class="fas fa-image-slash"></i> No Image';
                    btn3.classList.add('opacity-50', 'cursor-not-allowed');
                }

            } catch (e) {
                showToast("Error starting game. Please reload.", "error");
                console.error(e);
            } finally {
                toggleLoading(false);
            }
        }

        // --- Core Logic ---

        async function getRandomArticle() {
            // STRATEGY: Top 1000 Viewed Pages
            const yesterday = new Date(Date.now() - 2 * 86400000); 
            const yyyy = yesterday.getFullYear();
            const mm = String(yesterday.getMonth() + 1).padStart(2, '0');
            const dd = String(yesterday.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}/${mm}/${dd}`;

            const url = `https://wikimedia.org/api/rest_v1/metrics/pageviews/top/en.wikipedia/all-access/${dateStr}`;

            try {
                document.getElementById('loading-text').innerText = "Analyzing global traffic charts...";
                
                const res = await fetch(url);
                if (!res.ok) throw new Error("Pageviews API error");
                
                const data = await res.json();
                const articles = data.items[0].articles;

                const datePattern = /^(January|February|March|April|May|June|July|August|September|October|November|December)_\d{1,2}$/;
                const yearPattern = /^\d{4}$/;

                const candidates = articles.filter(a => {
                    const t = a.article;
                    
                    // Filter out dates and years
                    if (datePattern.test(t) || yearPattern.test(t)) return false;

                    // Filter out titles with Colons (Usually subtitles, episodes, specific events)
                    // e.g. "Kantara: Chapter 1", "Avengers: Endgame"
                    if (t.includes(":")) return false;

                    // Filter out long titles (Usually specific news events)
                    // e.g. "US_Military_strikes_on_venezuelan_cartel_boats"
                    // Limit to 4 words max.
                    if (t.split("_").length > 4) return false;

                    return t !== "Main_Page" &&
                           !t.startsWith("Special:") &&
                           !t.startsWith("Wikipedia:") &&
                           !t.startsWith("File:") &&
                           !t.startsWith("Portal:") &&
                           !t.startsWith("User:") &&
                           !t.startsWith("Help:") &&
                           !t.startsWith("List_of") && 
                           !t.includes("_(disambiguation)");
                });

                if (candidates.length > 0) {
                    const randomIdx = Math.floor(Math.random() * candidates.length);
                    return candidates[randomIdx].article.replace(/_/g, ' '); 
                } else {
                    throw new Error("No candidates found");
                }

            } catch (e) {
                console.error("Pageviews fetch failed, falling back...", e);
                return "The Internet"; 
            }
        }

        async function handleGuess(title) {
            if (isGameOver) return;
            
            if (guesses.some(g => g.title.toLowerCase() === title.toLowerCase())) {
                showToast("You already guessed that!", "error");
                return;
            }

            toggleLoading(true);
            
            try {
                const data = await fetchWikiData(title);
                if (!data) {
                    showToast("Article not found in Wikipedia!", "error");
                    toggleLoading(false);
                    return;
                }

                const result = calculateSimilarity(data.title, data.links);
                
                const guessObj = {
                    title: data.title,
                    ...result
                };
                guesses.unshift(guessObj);
                
                renderGuess(guessObj);
                updateStats();

                if (result.type === 'win') {
                    triggerWin();
                }

                const searchInput = document.getElementById('search-input');
                searchInput.value = '';
                document.getElementById('autocomplete-list').classList.add('hidden');

            } catch (e) {
                console.error(e);
                showToast("Error checking guess", "error");
            } finally {
                toggleLoading(false);
            }
        }

        function calculateSimilarity(guessTitle, guessLinksArr) {
            if (guessTitle.toLowerCase() === targetArticle.toLowerCase()) {
                return { score: 100, message: "Correct!", color: "bg-green-500", type: 'win' };
            }

            const guessLinks = new Set(guessLinksArr);
            const targetLinksToGuess = targetLinks.has(guessTitle);
            const guessLinksToTarget = guessLinks.has(targetArticle);

            if (targetLinksToGuess || guessLinksToTarget) {
                return { score: 85, message: "Direct Link!", color: "bg-orange-500", type: 'close' };
            }

            const intersection = new Set([...targetLinks].filter(x => guessLinks.has(x)));
            const union = new Set([...targetLinks, ...guessLinks]);
            
            let jaccard = 0;
            if (union.size > 0) {
                jaccard = intersection.size / union.size;
            }

            let displayScore = Math.min(Math.round(jaccard * 1000), 70); 
            
            let message = `${intersection.size} shared links`;
            let color = "bg-blue-500";

            if (intersection.size === 0) {
                message = "No connection";
                color = "bg-gray-400";
                displayScore = 5;
            }

            return { score: displayScore, message: message, color: color, type: 'normal' };
        }

        // --- Wikipedia API Helper ---
        
        async function fetchWikiData(title) {
            const params = new URLSearchParams({
                action: "query",
                format: "json",
                prop: "links|categories|extracts|pageimages|info",
                titles: title,
                pllimit: "max",
                cllimit: "max",
                explaintext: "1",      
                pithumbsize: "600",    
                inprop: "url",         
                origin: "*"
            });

            const res = await fetch(`${API_BASE}?${params.toString()}`);
            const data = await res.json();
            
            const pages = data.query.pages;
            const pageId = Object.keys(pages)[0];
            
            if (pageId === "-1") return null;

            const page = pages[pageId];
            
            const fullText = page.extract || "";
            const introEnd = fullText.search(/==[^=]+==/);
            const summary = introEnd !== -1 ? fullText.substring(0, introEnd).trim() : fullText.substring(0, 500);

            return {
                title: page.title,
                links: page.links ? page.links.map(l => l.title) : [],
                categories: page.categories ? page.categories.map(c => c.title.replace("Category:", "")) : [],
                summary: summary,
                fullText: fullText,
                image: page.thumbnail ? page.thumbnail.source : null,
                url: page.fullurl
            };
        }

        // --- Text Processing ---

        function processContextClue(fullText, title) {
            const lines = fullText.split('\n');
            let foundHeader = false;
            let contextParagraph = "";

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith("==") && line.endsWith("==")) {
                    // Check if this header is allowed
                    const headerText = line.replace(/=/g, '').trim().toLowerCase();
                    // Skip "Etymology", "Name" sections as they give away the answer
                    if (headerText.includes("etymology") || headerText.includes("name")) {
                        foundHeader = false; // Don't capture text from this section
                    } else {
                        foundHeader = true;
                    }
                    continue;
                }
                
                if (foundHeader && line.length > 50) {
                    contextParagraph = line;
                    break;
                }
            }

            if (!contextParagraph) {
                const sentences = fullText.split('. ');
                if (sentences.length > 1) {
                    contextParagraph = sentences[1] + ".";
                } else {
                    contextParagraph = fullText.substring(0, 100) + "...";
                }
            }

            // Create sentence version (Truncated)
            let sentence = contextParagraph;
            const periodIndex = contextParagraph.indexOf('. ');
            if (periodIndex !== -1) {
                sentence = contextParagraph.substring(0, periodIndex + 1);
            }

            return {
                sentence: redactText(sentence, title),
                full: redactText(contextParagraph, title)
            };
        }

        function redactText(text, title) {
            let censored = text;
            const titleWords = title.split(/[\s-]+/); 
            
            // --- Acronym Generation Logic ---
            if (titleWords.length > 1) {
                const acronym = titleWords.map(w => w.charAt(0)).join('');
                if (acronym.length > 1) titleWords.push(acronym);
            }

            titleWords.sort((a, b) => b.length - a.length);

            titleWords.forEach(word => {
                if (word.length > 2) {
                    // --- ROOT WORD REDACTION LOGIC ---
                    // For long words (e.g. "Germany"), we want to match words starting with same root (e.g. "Germ")
                    // This handles "German", "Germanic", "Germania" from "Germany".
                    let pattern = "";
                    const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    
                    if (word.length >= 5) {
                        // Take first 4 chars as root
                        const root = escapedWord.substring(0, 4);
                        // Regex: Boundary + Root + any word characters
                        pattern = `\\b${root}\\w*`;
                    } else {
                        // Standard match for short words
                        pattern = `\\b${escapedWord}\\w*`;
                    }

                    const regex = new RegExp(pattern, "gi"); 
                    censored = censored.replace(regex, "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ");
                }
            });
            return censored;
        }

        async function searchAutocomplete(term) {
            if (term.length < 2) return [];
            
            const params = new URLSearchParams({
                action: "opensearch",
                search: term,
                limit: "5",
                namespace: "0",
                format: "json",
                origin: "*"
            });

            const res = await fetch(`${API_BASE}?${params.toString()}`);
            const data = await res.json();
            return data[1]; 
        }

        // --- UI Rendering ---

        function renderGuess(guess) {
            const container = document.getElementById('guesses-container');
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            const div = document.createElement('div');
            div.className = "bg-white p-3 rounded-lg border border-gray-200 shadow-sm animate-pop flex items-center justify-between";
            div.innerHTML = `
                <div class="flex-1">
                    <div class="font-bold text-gray-800">${guess.title}</div>
                    <div class="text-xs text-gray-500">${guess.message}</div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${guess.color}" style="width: ${guess.score}%"></div>
                    </div>
                    <span class="text-sm font-bold w-8 text-right">${guess.score}%</span>
                </div>
            `;
            container.prepend(div);
        }

        function updateStats() {
            document.getElementById('guess-count').innerText = `${guesses.length} guess${guesses.length !== 1 ? 'es' : ''}`;
        }

        function renderRedactedSummary() {
            const display = document.getElementById('summary-text');
            const summarySnippet = targetSummary.substring(0, 400) + (targetSummary.length > 400 ? "..." : "");
            display.innerText = redactText(summarySnippet, targetArticle);
        }

        function revealHint(level) {
            hintsUnlocked++;
            document.getElementById('hint-status').innerText = `${hintsUnlocked}/4 Extra Hints Used`;

            const btn = document.getElementById(`btn-hint-${level}`);
            btn.disabled = true;
            btn.classList.remove('bg-indigo-50', 'text-indigo-700');
            btn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');

            if (level === 0) {
                // Expand Clue
                document.getElementById('context-display').innerText = targetContextData.full;
            
            } else if (level === 1) {
                // Summary
                const display = document.getElementById('hint-display-1');
                renderRedactedSummary();
                display.classList.remove('hidden');

            } else if (level === 2) {
                // Categories
                const display = document.getElementById('hint-display-2');
                
                // Aggressive "Stop List" for categories
                const cleanCats = targetCategories.filter(c => {
                    const lower = c.toLowerCase();
                    const titleLower = targetArticle.toLowerCase();
                    if (lower.includes(titleLower)) return false;
                    
                    return !lower.includes("articles") && 
                           !lower.includes("pages") && 
                           !lower.includes("webarchive") && 
                           !lower.includes("cs1") && 
                           !lower.includes("short description") &&
                           !lower.includes("disputes") &&      
                           !lower.includes("verification") &&  
                           !lower.includes("citations") &&     
                           !lower.includes("sources") &&       
                           !lower.includes("introduction") &&  
                           !lower.includes("cleanup") &&       
                           !lower.includes("template");        
                });

                // --- REDACTION FOR CATEGORIES ---
                // We need to apply the same redaction logic to the category text itself
                // because categories often contain the target word (e.g. "History of Germany")
                const safeCats = cleanCats.map(c => redactText(c, targetArticle));

                if (safeCats.length > 0) {
                    display.innerHTML = `<span class="block text-xs font-bold text-indigo-400 mb-1">CATEGORIES</span> ${safeCats.slice(0, 8).join(", ")}`;
                } else {
                    display.innerText = "No descriptive categories found.";
                }
                display.classList.remove('hidden');

            } else if (level === 3) {
                // Image
                const display = document.getElementById('hint-display-3');
                const img = document.getElementById('hint-image');
                if (targetImage) {
                    img.src = targetImage;
                    display.classList.remove('hidden');
                }
            }
        }

        function triggerWin() {
            isGameOver = true;
            document.getElementById('reveal-title').innerText = targetArticle;
            document.getElementById('win-stats').innerText = `Solved in ${guesses.length} guesses!`;
            
            const link = document.getElementById('wiki-link');
            link.href = targetUrl;
            
            document.getElementById('win-screen').classList.remove('hidden');
            document.getElementById('search-input').disabled = true;
            
            // Reveal everything
            if(targetImage) {
                document.getElementById('hint-display-3').classList.remove('hidden');
                document.getElementById('hint-image').src = targetImage;
            }
            const summaryDisplay = document.getElementById('summary-text');
            summaryDisplay.innerText = targetSummary.substring(0, 600) + "...";
            document.getElementById('hint-display-1').classList.remove('hidden');
            
            // NOTE: We do NOT overwrite context-display anymore so user can see original clue.
        }

        function giveUp() {
            const btn = document.getElementById('give-up-btn');
            
            if (giveUpClickCount === 0) {
                giveUpClickCount++;
                btn.innerText = "Are you sure? Click again to confirm.";
                btn.classList.remove('text-red-400');
                btn.classList.add('text-red-600', 'font-bold');
                return;
            }

            triggerWin(); 
            
            const winScreen = document.getElementById('win-screen');
            winScreen.classList.remove('bg-green-100', 'border-green-500');
            winScreen.classList.add('bg-red-50', 'border-red-200');
            
            const winTitle = winScreen.querySelector('h2');
            winTitle.innerText = "ðŸ˜¢ Game Over";
            winTitle.classList.remove('text-green-700');
            winTitle.classList.add('text-red-700');
            
            const link = document.getElementById('wiki-link');
            link.classList.remove('text-green-700');
            link.classList.add('text-red-700', 'hover:text-red-800');
            
            document.getElementById('win-stats').innerText = "Better luck next time!";
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const bgClass = type === 'error' ? 'bg-red-500' : 'bg-indigo-600';
            const icon = type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>';
            
            toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium pointer-events-auto toast-enter`;
            toast.innerHTML = `${icon} <span>${message}</span>`;
            
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.transition = 'all 0.3s ease-in';
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleLoading(show) {
            const el = document.getElementById('loading-screen');
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        // --- Event Listeners ---

        const searchInput = document.getElementById('search-input');
        const autoList = document.getElementById('autocomplete-list');

        let timeout = null;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(timeout);
            const term = e.target.value;
            
            if (term.length < 2) {
                autoList.classList.add('hidden');
                return;
            }

            timeout = setTimeout(async () => {
                const results = await searchAutocomplete(term);
                if (results.length > 0) {
                    autoList.innerHTML = results.map(r => 
                        `<div class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100" onclick="selectSuggestion('${r.replace(/'/g, "\\'")}')">${r}</div>`
                    ).join('');
                    autoList.classList.remove('hidden');
                } else {
                    autoList.classList.add('hidden');
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !autoList.contains(e.target)) {
                autoList.classList.add('hidden');
            }
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && searchInput.value) {
                handleGuess(searchInput.value);
                autoList.classList.add('hidden');
            }
        });

        window.selectSuggestion = (title) => {
            searchInput.value = title;
            autoList.classList.add('hidden');
            handleGuess(title);
        };

    </script>
</body>
</html>
